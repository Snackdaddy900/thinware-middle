<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Send this 3D config for a quote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 640px;
      margin: 2rem auto;
      padding: 1rem;
      line-height: 1.5;
    }
    label { display: block; margin-top: 1rem; }
    input, textarea {
      width: 100%;
      padding: 0.5rem;
      box-sizing: border-box;
      margin-top: 0.25rem;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      cursor: pointer;
    }
    .config-summary {
      font-size: 0.9rem;
      background: #f4f4f4;
      padding: 0.75rem;
      margin-top: 1rem;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .status {
      margin-top: 1rem;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <h1>Send this configuration for a quote</h1>
  <p>Confirm your details and we’ll email this configuration through.</p>

  <div id="configSummary" class="config-summary"></div>

  <form id="quoteForm">
    <label>
      Your name
      <input type="text" name="leadName" required />
    </label>

    <label>
      Your email
      <input type="email" name="leadEmail" required />
    </label>

    <label>
      Company (optional)
      <input type="text" name="companyName" />
    </label>

    <label>
      Notes (optional)
      <textarea name="notes" rows="3" placeholder="Anything special we should know?"></textarea>
    </label>

    <button type="submit">Send configuration</button>
  </form>

  <div id="status" class="status"></div>

  <script>
    // --- 1. Parse URL parameters (from Vectary) ---
    const params = new URLSearchParams(window.location.search);
    const configObject = Object.fromEntries(params.entries());

    const product = params.get("product") || "Cubes & Spheres Test";
    const price = params.get("price") || "";
    const configId = params.get("configId") || "";

    // Show a simple summary
    const configSummaryEl = document.getElementById("configSummary");
    configSummaryEl.textContent =
      "Product: " + product + (price ? " | Price: " + price : "") +
      (configId ? " | Config ID: " + configId : "") +
      "\n\nFull configuration:\n" + JSON.stringify(configObject, null, 2);

    // --- 2. Handle submit & POST to Netlify function ---
    const form = document.getElementById("quoteForm");
    const statusEl = document.getElementById("status");

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      statusEl.textContent = "Sending configuration…";

      const formData = new FormData(form);
      const leadName = formData.get("leadName");
      const leadEmail = formData.get("leadEmail");
      const companyName = formData.get("companyName") || "";
      const notes = formData.get("notes") || "";

      const payload = {
        leadName,
        leadEmail,
        companyName,
        notes,
        product,
        config: configObject,      // EVERYTHING from the URL
        price,
        configId,
        sourceUrl: window.location.href
      };

      try {
        const res = await fetch("/.netlify/functions/send-quote-lead", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        if (res.ok && data.ok !== false) {
          statusEl.textContent = "Done – your configuration has been sent.";
          form.reset();
        } else {
          statusEl.textContent =
            "Sorry, something went wrong sending the configuration.";
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent =
          "Network error – please try again in a moment.";
      }
    });
  </script>
</body>
</html>
